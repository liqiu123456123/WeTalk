<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0,user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>音量</title>
    <style>



    </style>
</head>
<body>
<audio id="video" src=""></audio>
<script type="text/javascript">
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    // 获取用户的媒体信息
    navigator.mediaDevices.getUserMedia({
        video: false,
        audio: {
            sampleRate: 44100,
            channelCount: 2,
            volume: 1.0
        }
    }).then((stream) => {
        const audioContext = new AudioContext();
        const socket = new WebSocket('ws://192.168.60.105:8765');

        // 设置WebSocket事件监听器
        socket.onopen = () => console.log('WebSocket is open');
        socket.onerror = (error) => console.error('WebSocket Error:', error);
        socket.onclose = (event) => console.log('WebSocket is closed', event);

        const mediaStreamSource = audioContext.createMediaStreamSource(stream);
        const scriptProcessor = audioContext.createScriptProcessor(4096, 2, 2);

        mediaStreamSource.connect(scriptProcessor);
        scriptProcessor.connect(audioContext.destination);

        let buffer = new Int16Array(4096 * 2); // 预先分配足够空间
        let i2 = 0;

        scriptProcessor.onaudioprocess = function(e) {
            const inputBuffer = e.inputBuffer;
            const channelData = inputBuffer.getChannelData(0);
            const channelData1 = inputBuffer.getChannelData(1);

            for (let i = 0; i < channelData.length; i++) {
                buffer[i2++] = Math.trunc(channelData[i] * 30000);
                buffer[i2++] = Math.trunc(channelData1[i] * 30000);
            }

            // 发送二进制数据
            socket.send(buffer.buffer);

            // 重置索引以准备下一次的音频数据填充
            i2 = 0;
        };
    }).catch((error) => {
        console.error('Error accessing microphone:', error);
    });
} else {
    console.error('getUserMedia is not supported on this browser.');
}
</script>
</body>
</html>

